<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenAI Function Calling for Crypto Trading — Purple Flea</title>
  <meta name="description" content="Use GPT-4 and GPT-4o function calling to build a crypto trading assistant. Complete working examples for opening positions, swaps, and casino on Purple Flea." />
  <link rel="canonical" href="https://purpleflea.com/openai-function-calling-crypto" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://purpleflea.com/openai-function-calling-crypto" />
  <meta property="og:title" content="OpenAI Function Calling for Crypto Trading — Purple Flea" />
  <meta property="og:description" content="Use GPT-4 and GPT-4o function calling to build a crypto trading assistant. Complete working examples for opening positions, swaps, and casino on Purple Flea." />
  <meta property="og:image" content="https://purpleflea.com/og-image.png" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="OpenAI Function Calling for Crypto Trading — Purple Flea" />
  <meta name="twitter:description" content="Use GPT-4 and GPT-4o function calling to build a crypto trading assistant. Complete working examples for opening positions, swaps, and casino on Purple Flea." />
  <meta name="twitter:image" content="https://purpleflea.com/og-image.png" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --purple: #A855F7;
      --purple-dim: #7C3AED;
      --bg: #09090B;
      --bg-card: rgba(255,255,255,0.03);
      --border: rgba(255,255,255,0.06);
      --text: #FAFAFA;
      --text-secondary: #A1A1AA;
      --text-muted: #71717A;
      --green: #22C55E;
      --mono: 'JetBrains Mono', monospace;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      line-height: 1.6;
      font-size: 16px;
    }

    a { color: var(--purple); text-decoration: none; }
    a:hover { color: var(--text); }

    nav {
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: rgba(9,9,11,0.92);
      backdrop-filter: blur(12px);
      z-index: 100;
    }

    .nav-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 17px;
      color: var(--text);
      text-decoration: none;
    }

    .nav-logo .diamond { color: var(--purple); font-size: 20px; line-height: 1; }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 28px;
      list-style: none;
    }

    .nav-links a {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      transition: color 0.15s;
    }

    .nav-links a:hover { color: var(--text); }

    .container {
      max-width: 860px;
      margin: 0 auto;
      padding: 0 24px;
    }

    .hero {
      padding: 80px 24px 64px;
      text-align: center;
      max-width: 860px;
      margin: 0 auto;
    }

    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(168,85,247,0.1);
      border: 1px solid rgba(168,85,247,0.25);
      border-radius: 9999px;
      padding: 4px 14px;
      font-size: 12px;
      font-weight: 600;
      color: var(--purple);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin-bottom: 24px;
    }

    .hero h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 700;
      line-height: 1.18;
      letter-spacing: -0.02em;
      margin-bottom: 20px;
    }

    .hero h1 span { color: var(--purple); }

    .hero p {
      font-size: 18px;
      color: var(--text-secondary);
      max-width: 620px;
      margin: 0 auto 36px;
      line-height: 1.7;
    }

    .hero-cta {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--purple);
      color: #fff;
      font-weight: 600;
      font-size: 15px;
      padding: 11px 24px;
      border-radius: 8px;
      transition: background 0.15s;
      text-decoration: none;
    }

    .hero-cta:hover { background: var(--purple-dim); color: #fff; }

    .section {
      padding: 60px 0;
      border-top: 1px solid var(--border);
    }

    .section-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--purple);
      margin-bottom: 12px;
    }

    h2 {
      font-size: clamp(1.4rem, 3vw, 1.9rem);
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 16px;
      line-height: 1.25;
    }

    h3 {
      font-size: 1.15rem;
      font-weight: 600;
      margin-bottom: 10px;
      margin-top: 32px;
      color: var(--text);
    }

    p {
      color: var(--text-secondary);
      margin-bottom: 16px;
      line-height: 1.75;
    }

    .code-block {
      position: relative;
      margin: 24px 0;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      overflow: hidden;
    }

    .code-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
    }

    .code-lang {
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .copy-btn {
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 3px 10px;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      letter-spacing: 0.04em;
    }

    .copy-btn:hover { color: var(--purple); border-color: var(--purple); }
    .copy-btn.copied { color: var(--green); border-color: var(--green); }

    pre {
      padding: 20px;
      overflow-x: auto;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.7;
      color: #e2e8f0;
    }

    code {
      font-family: var(--mono);
      font-size: 13px;
    }

    p code, li code {
      background: rgba(168,85,247,0.12);
      border: 1px solid rgba(168,85,247,0.2);
      border-radius: 4px;
      padding: 1px 6px;
      color: var(--purple);
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
    }

    .card-icon { font-size: 22px; margin-bottom: 10px; }

    .card h4 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text);
    }

    .card p {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 0;
      line-height: 1.6;
    }

    .feature-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 20px 0;
    }

    .feature-list li {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      color: var(--text-secondary);
      font-size: 15px;
    }

    .feature-list li::before {
      content: '';
      width: 18px;
      height: 18px;
      min-width: 18px;
      border-radius: 50%;
      background: rgba(34,197,94,0.15);
      border: 1px solid rgba(34,197,94,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 2px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' fill='none'%3E%3Cpath d='M2.5 6l2.5 2.5 4.5-5' stroke='%2322C55E' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: center;
    }

    .callout {
      background: rgba(168,85,247,0.06);
      border: 1px solid rgba(168,85,247,0.2);
      border-radius: 10px;
      padding: 20px 24px;
      margin: 24px 0;
    }

    .callout p { margin-bottom: 0; color: var(--text-secondary); }
    .callout strong { color: var(--purple); }

    .callout-warn {
      background: rgba(245,158,11,0.06);
      border: 1px solid rgba(245,158,11,0.2);
      border-radius: 10px;
      padding: 20px 24px;
      margin: 24px 0;
    }

    .callout-warn p { margin-bottom: 0; color: var(--text-secondary); }
    .callout-warn strong { color: #F59E0B; }

    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin: 20px 0;
    }

    .col-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    footer {
      border-top: 1px solid var(--border);
      padding: 40px 24px;
      margin-top: 80px;
    }

    .footer-inner {
      max-width: 860px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .footer-brand {
      display: flex;
      align-items: center;
      gap: 7px;
      font-weight: 700;
      font-size: 15px;
      color: var(--text);
    }

    .footer-brand .diamond { color: var(--purple); }

    .footer-links {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      list-style: none;
    }

    .footer-links a {
      font-size: 13px;
      color: var(--text-muted);
      transition: color 0.15s;
    }

    .footer-links a:hover { color: var(--text); }

    .footer-copy {
      font-size: 12px;
      color: var(--text-muted);
      width: 100%;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      text-align: center;
    }

    /* Syntax colors */
    .kw { color: #c792ea; }
    .st { color: #c3e88d; }
    .cm { color: #546e7a; font-style: italic; }
    .nm { color: #82aaff; }
    .op { color: #89ddff; }
    .nu { color: #f78c6c; }
    .fn { color: #82aaff; }
    .at { color: #ffcb6b; }

    @media (max-width: 640px) {
      .nav-links { display: none; }
      .two-col { grid-template-columns: 1fr; }
      .footer-inner { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>

<nav>
  <a href="https://purpleflea.com" class="nav-logo">
    <span class="diamond">&#9830;</span>
    Purple Flea
  </a>
  <ul class="nav-links">
    <li><a href="https://purpleflea.com">Home</a></li>
    <li><a href="https://purpleflea.com/docs">Docs</a></li>
    <li><a href="https://purpleflea.com/for-agents">For Agents</a></li>
    <li><a href="https://purpleflea.com/stats">Stats</a></li>
    <li><a href="https://github.com/purpleflea">GitHub</a></li>
  </ul>
</nav>

<main>
  <section class="hero">
    <div class="hero-badge">OpenAI &mdash; GPT-4 &amp; GPT-4o</div>
    <h1>Build a <span>GPT-4 crypto trading assistant</span> with Purple Flea</h1>
    <p>Complete, runnable examples for OpenAI function calling — open positions, execute swaps, and run casino operations directly from a GPT-4o chat loop.</p>
    <a href="https://purpleflea.com/docs" class="hero-cta">View API docs &rarr;</a>
  </section>

  <div class="container">

    <!-- GPT-4 + PURPLE FLEA -->
    <section class="section">
      <div class="section-label">Overview</div>
      <h2>GPT-4 and GPT-4o tool use with Purple Flea</h2>
      <p>OpenAI's <code>tools</code> parameter (formerly <code>functions</code>) lets GPT-4, GPT-4o, and GPT-4o-mini decide autonomously when to call your Purple Flea integrations. The model returns a structured <code>tool_calls</code> array; your code dispatches to the correct Purple Flea endpoint and feeds the result back as a <code>tool</code> role message.</p>

      <div class="card-grid">
        <div class="card">
          <div class="card-icon">&#9650;</div>
          <h4>GPT-4o</h4>
          <p>Best reasoning + fastest. Recommended for trading decisions and multi-step agent loops.</p>
        </div>
        <div class="card">
          <div class="card-icon">&#9679;</div>
          <h4>GPT-4o-mini</h4>
          <p>10&times; cheaper. Use for high-frequency polling, balance checks, and simple swaps.</p>
        </div>
        <div class="card">
          <div class="card-icon">&#9632;</div>
          <h4>Parallel calls</h4>
          <p>GPT-4o can invoke multiple tools simultaneously in a single turn — check balance + check market + open position in one round-trip.</p>
        </div>
        <div class="card">
          <div class="card-icon">&#9830;</div>
          <h4>Streaming</h4>
          <p>Stream tool call deltas for real-time feedback as the model constructs its arguments.</p>
        </div>
      </div>
    </section>

    <!-- COMPLETE TRADING ASSISTANT -->
    <section class="section">
      <div class="section-label">Complete Example</div>
      <h2>A GPT-4o trading assistant — full working code</h2>
      <p>This is a complete, runnable trading assistant. It accepts natural-language commands and dispatches to Purple Flea Trading (open/close positions), Purple Flea Wallet (swaps), and Purple Flea Casino (coin flips).</p>

      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">Python — complete GPT-4o trading agent</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="kw">import</span> json
<span class="kw">import</span> requests
<span class="kw">from</span> openai <span class="kw">import</span> OpenAI

client <span class="op">=</span> <span class="fn">OpenAI</span>()  <span class="cm"># reads OPENAI_API_KEY from env</span>

PURPLE_FLEA_KEY <span class="op">=</span> <span class="st">"sk_live_..."</span>
HEADERS <span class="op">=</span> {<span class="st">"Authorization"</span>: <span class="st">f"Bearer {PURPLE_FLEA_KEY}"</span>}

<span class="cm"># ── Tool definitions ────────────────────────────────────────────</span>
TOOLS <span class="op">=</span> [
  {
    <span class="st">"type"</span>: <span class="st">"function"</span>,
    <span class="st">"function"</span>: {
      <span class="st">"name"</span>: <span class="st">"get_balance"</span>,
      <span class="st">"description"</span>: <span class="st">"Get the agent wallet balance for a specific chain and token."</span>,
      <span class="st">"parameters"</span>: {
        <span class="st">"type"</span>: <span class="st">"object"</span>,
        <span class="st">"properties"</span>: {
          <span class="st">"chain"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>, <span class="st">"enum"</span>: [<span class="st">"ethereum"</span>, <span class="st">"base"</span>, <span class="st">"arbitrum"</span>, <span class="st">"solana"</span>]},
          <span class="st">"token"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>, <span class="st">"description"</span>: <span class="st">"Token symbol, e.g. USDC, ETH"</span>}
        },
        <span class="st">"required"</span>: [<span class="st">"chain"</span>, <span class="st">"token"</span>]
      }
    }
  },
  {
    <span class="st">"type"</span>: <span class="st">"function"</span>,
    <span class="st">"function"</span>: {
      <span class="st">"name"</span>: <span class="st">"get_market_price"</span>,
      <span class="st">"description"</span>: <span class="st">"Get the current mid price and 24h change for a perp market."</span>,
      <span class="st">"parameters"</span>: {
        <span class="st">"type"</span>: <span class="st">"object"</span>,
        <span class="st">"properties"</span>: {
          <span class="st">"market"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>, <span class="st">"description"</span>: <span class="st">"Market ID, e.g. ETH-PERP"</span>}
        },
        <span class="st">"required"</span>: [<span class="st">"market"</span>]
      }
    }
  },
  {
    <span class="st">"type"</span>: <span class="st">"function"</span>,
    <span class="st">"function"</span>: {
      <span class="st">"name"</span>: <span class="st">"trading_open_position"</span>,
      <span class="st">"description"</span>: <span class="st">"Open a perpetual futures position on Purple Flea Trading."</span>,
      <span class="st">"parameters"</span>: {
        <span class="st">"type"</span>: <span class="st">"object"</span>,
        <span class="st">"properties"</span>: {
          <span class="st">"market"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>},
          <span class="st">"side"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>, <span class="st">"enum"</span>: [<span class="st">"long"</span>, <span class="st">"short"</span>]},
          <span class="st">"size"</span>: {<span class="st">"type"</span>: <span class="st">"number"</span>, <span class="st">"description"</span>: <span class="st">"USD notional"</span>},
          <span class="st">"leverage"</span>: {<span class="st">"type"</span>: <span class="st">"integer"</span>, <span class="st">"minimum"</span>: <span class="nu">1</span>, <span class="st">"maximum"</span>: <span class="nu">50</span>},
          <span class="st">"take_profit"</span>: {<span class="st">"type"</span>: <span class="st">"number"</span>, <span class="st">"description"</span>: <span class="st">"TP price (optional)"</span>},
          <span class="st">"stop_loss"</span>: {<span class="st">"type"</span>: <span class="st">"number"</span>, <span class="st">"description"</span>: <span class="st">"SL price (optional)"</span>}
        },
        <span class="st">"required"</span>: [<span class="st">"market"</span>, <span class="st">"side"</span>, <span class="st">"size"</span>]
      }
    }
  },
  {
    <span class="st">"type"</span>: <span class="st">"function"</span>,
    <span class="st">"function"</span>: {
      <span class="st">"name"</span>: <span class="st">"trading_close_position"</span>,
      <span class="st">"description"</span>: <span class="st">"Close an open position by position ID."</span>,
      <span class="st">"parameters"</span>: {
        <span class="st">"type"</span>: <span class="st">"object"</span>,
        <span class="st">"properties"</span>: {
          <span class="st">"position_id"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>}
        },
        <span class="st">"required"</span>: [<span class="st">"position_id"</span>]
      }
    }
  },
  {
    <span class="st">"type"</span>: <span class="st">"function"</span>,
    <span class="st">"function"</span>: {
      <span class="st">"name"</span>: <span class="st">"wallet_swap"</span>,
      <span class="st">"description"</span>: <span class="st">"Execute a best-rate cross-chain token swap via Purple Flea Wallet."</span>,
      <span class="st">"parameters"</span>: {
        <span class="st">"type"</span>: <span class="st">"object"</span>,
        <span class="st">"properties"</span>: {
          <span class="st">"from_chain"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>},
          <span class="st">"to_chain"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>},
          <span class="st">"from_token"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>},
          <span class="st">"to_token"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>},
          <span class="st">"amount"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>}
        },
        <span class="st">"required"</span>: [<span class="st">"from_chain"</span>, <span class="st">"to_chain"</span>, <span class="st">"from_token"</span>, <span class="st">"to_token"</span>, <span class="st">"amount"</span>]
      }
    }
  },
  {
    <span class="st">"type"</span>: <span class="st">"function"</span>,
    <span class="st">"function"</span>: {
      <span class="st">"name"</span>: <span class="st">"casino_flip"</span>,
      <span class="st">"description"</span>: <span class="st">"Flip a provably fair coin on Purple Flea Casino."</span>,
      <span class="st">"parameters"</span>: {
        <span class="st">"type"</span>: <span class="st">"object"</span>,
        <span class="st">"properties"</span>: {
          <span class="st">"amount"</span>: {<span class="st">"type"</span>: <span class="st">"number"</span>},
          <span class="st">"side"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>, <span class="st">"enum"</span>: [<span class="st">"heads"</span>, <span class="st">"tails"</span>]}
        },
        <span class="st">"required"</span>: [<span class="st">"amount"</span>, <span class="st">"side"</span>]
      }
    }
  }
]

<span class="cm"># ── Tool dispatch ────────────────────────────────────────────────</span>
<span class="kw">def</span> <span class="fn">dispatch</span>(name, args):
    <span class="kw">if</span> name <span class="op">==</span> <span class="st">"get_balance"</span>:
        r <span class="op">=</span> requests.<span class="fn">get</span>(<span class="st">f"https://wallet.purpleflea.com/v1/balance"</span>,
            headers<span class="op">=</span>HEADERS, params<span class="op">=</span>args)
        <span class="kw">return</span> r.<span class="fn">json</span>()
    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"get_market_price"</span>:
        r <span class="op">=</span> requests.<span class="fn">get</span>(<span class="st">f"https://api.purpleflea.com/v1/markets/{args['market']}/price"</span>,
            headers<span class="op">=</span>HEADERS)
        <span class="kw">return</span> r.<span class="fn">json</span>()
    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"trading_open_position"</span>:
        r <span class="op">=</span> requests.<span class="fn">post</span>(<span class="st">"https://api.purpleflea.com/v1/trading/open"</span>,
            headers<span class="op">=</span>HEADERS, json<span class="op">=</span>args)
        <span class="kw">return</span> r.<span class="fn">json</span>()
    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"trading_close_position"</span>:
        r <span class="op">=</span> requests.<span class="fn">post</span>(<span class="st">"https://api.purpleflea.com/v1/trading/close"</span>,
            headers<span class="op">=</span>HEADERS, json<span class="op">=</span>args)
        <span class="kw">return</span> r.<span class="fn">json</span>()
    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"wallet_swap"</span>:
        r <span class="op">=</span> requests.<span class="fn">post</span>(<span class="st">"https://wallet.purpleflea.com/v1/wallet/swap"</span>,
            headers<span class="op">=</span>HEADERS, json<span class="op">=</span>args)
        <span class="kw">return</span> r.<span class="fn">json</span>()
    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"casino_flip"</span>:
        r <span class="op">=</span> requests.<span class="fn">post</span>(<span class="st">"https://api.purpleflea.com/api/v1/flip"</span>,
            headers<span class="op">=</span>HEADERS, json<span class="op">=</span>args)
        <span class="kw">return</span> r.<span class="fn">json</span>()
    <span class="kw">return</span> {<span class="st">"error"</span>: <span class="st">"unknown tool"</span>}

<span class="cm"># ── Agent loop ───────────────────────────────────────────────────</span>
<span class="kw">def</span> <span class="fn">run_agent</span>(user_message: str):
    messages <span class="op">=</span> [
        {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: <span class="st">"You are a crypto trading assistant powered by Purple Flea. Execute operations accurately and confirm before placing large trades."</span>},
        {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: user_message}
    ]

    <span class="kw">while</span> <span class="kw">True</span>:
        response <span class="op">=</span> client.chat.completions.<span class="fn">create</span>(
            model<span class="op">=</span><span class="st">"gpt-4o"</span>,
            messages<span class="op">=</span>messages,
            tools<span class="op">=</span>TOOLS,
            tool_choice<span class="op">=</span><span class="st">"auto"</span>
        )
        msg <span class="op">=</span> response.choices[<span class="nu">0</span>].message

        <span class="kw">if not</span> msg.tool_calls:
            <span class="kw">return</span> msg.content  <span class="cm"># final text response</span>

        messages.<span class="fn">append</span>(msg)

        <span class="kw">for</span> tc <span class="kw">in</span> msg.tool_calls:
            args <span class="op">=</span> json.<span class="fn">loads</span>(tc.function.arguments)
            result <span class="op">=</span> <span class="fn">dispatch</span>(tc.function.name, args)
            messages.<span class="fn">append</span>({
                <span class="st">"role"</span>: <span class="st">"tool"</span>,
                <span class="st">"tool_call_id"</span>: tc.id,
                <span class="st">"content"</span>: json.<span class="fn">dumps</span>(result)
            })

<span class="cm"># Usage</span>
print(<span class="fn">run_agent</span>(<span class="st">"Check my USDC balance on Base, get the ETH-PERP price, and open a $500 long at 5x leverage."</span>))</code></pre>
      </div>
    </section>

    <!-- PARALLEL TOOL CALLS -->
    <section class="section">
      <div class="section-label">Parallel Calls</div>
      <h2>Parallel tool calls — do three things at once</h2>
      <p>GPT-4o supports parallel function calling: when the model determines that multiple tools can be invoked without depending on each other's results, it returns all of them in the same turn. This is a significant latency win for agent operations.</p>

      <p>The prompt <em>"Check my USDC balance on Base, get the ETH-PERP price, and open a $500 long"</em> will cause GPT-4o to emit three <code>tool_calls</code> simultaneously — <code>get_balance</code>, <code>get_market_price</code>, and (after receiving those results) <code>trading_open_position</code>.</p>

      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">Python — handling parallel tool_calls</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="cm"># GPT-4o may return multiple tool_calls in one message</span>
<span class="kw">import</span> concurrent.futures

<span class="kw">def</span> <span class="fn">handle_parallel_tool_calls</span>(msg, messages):
    tool_calls <span class="op">=</span> msg.tool_calls
    <span class="kw">if not</span> tool_calls:
        <span class="kw">return</span> messages

    <span class="cm"># Run all tool calls concurrently</span>
    <span class="kw">def</span> <span class="fn">execute_one</span>(tc):
        args <span class="op">=</span> json.<span class="fn">loads</span>(tc.function.arguments)
        result <span class="op">=</span> <span class="fn">dispatch</span>(tc.function.name, args)
        <span class="kw">return</span> (tc.id, result)

    <span class="kw">with</span> concurrent.futures.<span class="fn">ThreadPoolExecutor</span>() <span class="kw">as</span> ex:
        futures <span class="op">=</span> [ex.<span class="fn">submit</span>(execute_one, tc) <span class="kw">for</span> tc <span class="kw">in</span> tool_calls]
        results <span class="op">=</span> [f.<span class="fn">result</span>() <span class="kw">for</span> f <span class="kw">in</span> concurrent.futures.<span class="fn">as_completed</span>(futures)]

    messages.<span class="fn">append</span>(msg)
    <span class="kw">for</span> tool_call_id, result <span class="kw">in</span> results:
        messages.<span class="fn">append</span>({
            <span class="st">"role"</span>: <span class="st">"tool"</span>,
            <span class="st">"tool_call_id"</span>: tool_call_id,
            <span class="st">"content"</span>: json.<span class="fn">dumps</span>(result)
        })
    <span class="kw">return</span> messages</code></pre>
      </div>
    </section>

    <!-- TOOL CHOICE -->
    <section class="section">
      <div class="section-label">Tool Choice</div>
      <h2><code>tool_choice</code>: auto vs forced</h2>
      <p>The <code>tool_choice</code> parameter controls how aggressively the model uses tools. Choose the right mode for your use case.</p>

      <div class="two-col">
        <div>
          <div class="col-label">tool_choice: "auto"</div>
          <div class="code-block">
            <div class="code-header">
              <span class="code-lang">Python</span>
              <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            </div>
            <pre><code><span class="cm"># Model decides when to call tools</span>
<span class="cm"># Best for conversational agents</span>
response <span class="op">=</span> client.chat.completions.<span class="fn">create</span>(
    model<span class="op">=</span><span class="st">"gpt-4o"</span>,
    messages<span class="op">=</span>messages,
    tools<span class="op">=</span>TOOLS,
    tool_choice<span class="op">=</span><span class="st">"auto"</span>
)</code></pre>
          </div>
        </div>
        <div>
          <div class="col-label">tool_choice: force specific tool</div>
          <div class="code-block">
            <div class="code-header">
              <span class="code-lang">Python</span>
              <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            </div>
            <pre><code><span class="cm"># Force the model to call one tool</span>
<span class="cm"># Best for deterministic pipelines</span>
response <span class="op">=</span> client.chat.completions.<span class="fn">create</span>(
    model<span class="op">=</span><span class="st">"gpt-4o"</span>,
    messages<span class="op">=</span>messages,
    tools<span class="op">=</span>TOOLS,
    tool_choice<span class="op">=</span>{
        <span class="st">"type"</span>: <span class="st">"function"</span>,
        <span class="st">"function"</span>: {
            <span class="st">"name"</span>: <span class="st">"trading_open_position"</span>
        }
    }
)</code></pre>
          </div>
        </div>
      </div>

      <ul class="feature-list">
        <li>Use <code>"auto"</code> for conversational trading assistants that need to answer questions and execute trades</li>
        <li>Use forced tool choice for deterministic pipelines where you know exactly which operation to run</li>
        <li>Use <code>"none"</code> to disable tools temporarily, e.g. when generating a summary after all trades are done</li>
        <li>Use <code>"required"</code> to force the model to call at least one tool — useful for structured data extraction</li>
      </ul>
    </section>

    <!-- STREAMING TOOL CALLS -->
    <section class="section">
      <div class="section-label">Streaming</div>
      <h2>Streaming tool calls for real-time feedback</h2>
      <p>With streaming enabled, you receive tool call argument deltas as the model builds them. This lets you show users what the agent is doing before the arguments are complete — useful for large position sizes or complex swap routes where users want confidence before execution.</p>

      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">Python — streaming tool call deltas</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="kw">from</span> openai <span class="kw">import</span> OpenAI

client <span class="op">=</span> <span class="fn">OpenAI</span>()

stream <span class="op">=</span> client.chat.completions.<span class="fn">create</span>(
    model<span class="op">=</span><span class="st">"gpt-4o"</span>,
    messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: <span class="st">"Open a $1000 ETH-PERP long at 10x leverage."</span>}],
    tools<span class="op">=</span>TOOLS,
    stream<span class="op">=</span><span class="kw">True</span>
)

tool_call_args <span class="op">=</span> <span class="st">""</span>
tool_call_name <span class="op">=</span> <span class="st">""</span>
tool_call_id <span class="op">=</span> <span class="kw">None</span>

<span class="kw">for</span> chunk <span class="kw">in</span> stream:
    delta <span class="op">=</span> chunk.choices[<span class="nu">0</span>].delta

    <span class="kw">if</span> delta.tool_calls:
        tc_delta <span class="op">=</span> delta.tool_calls[<span class="nu">0</span>]

        <span class="kw">if</span> tc_delta.id:
            tool_call_id <span class="op">=</span> tc_delta.id

        <span class="kw">if</span> tc_delta.function.name:
            tool_call_name <span class="op">=</span> tc_delta.function.name
            print(<span class="st">f"[calling {tool_call_name}...]"</span>, flush<span class="op">=</span><span class="kw">True</span>)

        <span class="kw">if</span> tc_delta.function.arguments:
            tool_call_args <span class="op">+=</span> tc_delta.function.arguments
            <span class="cm"># Stream argument construction to UI in real time</span>
            print(tc_delta.function.arguments, end<span class="op">=</span><span class="st">""</span>, flush<span class="op">=</span><span class="kw">True</span>)

<span class="cm"># Once streaming is done, dispatch</span>
args <span class="op">=</span> json.<span class="fn">loads</span>(tool_call_args)
result <span class="op">=</span> <span class="fn">dispatch</span>(tool_call_name, args)
print(<span class="st">f"\nResult: {result}"</span>)</code></pre>
      </div>
    </section>

    <!-- ERROR HANDLING -->
    <section class="section">
      <div class="section-label">Error Handling</div>
      <h2>Error handling patterns</h2>
      <p>Financial operations require robust error handling. Below are the three layers you need: API-level errors from Purple Flea, network errors, and model-level argument validation failures.</p>

      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">Python — production error handling</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="kw">import</span> logging
<span class="kw">from</span> typing <span class="kw">import</span> Any

logger <span class="op">=</span> logging.<span class="fn">getLogger</span>(<span class="st">"trading_agent"</span>)

<span class="kw">class</span> <span class="nm">PurpleFleaError</span>(Exception):
    <span class="kw">def</span> <span class="fn">__init__</span>(self, code: str, message: str):
        self.code <span class="op">=</span> code
        self.message <span class="op">=</span> message
        <span class="fn">super()</span>.<span class="fn">__init__</span>(message)

<span class="kw">def</span> <span class="fn">safe_dispatch</span>(name: str, args: dict) <span class="op">-></span> dict[str, Any]:
    <span class="kw">try</span>:
        result <span class="op">=</span> <span class="fn">dispatch</span>(name, args)

        <span class="cm"># Purple Flea returns {"error": {...}} on API errors</span>
        <span class="kw">if</span> <span class="st">"error"</span> <span class="kw">in</span> result:
            err <span class="op">=</span> result[<span class="st">"error"</span>]
            logger.<span class="fn">warning</span>(<span class="st">f"Purple Flea API error: {err}"</span>)
            <span class="kw">return</span> {
                <span class="st">"success"</span>: <span class="kw">False</span>,
                <span class="st">"error_code"</span>: err.<span class="fn">get</span>(<span class="st">"code"</span>, <span class="st">"unknown"</span>),
                <span class="st">"message"</span>: err.<span class="fn">get</span>(<span class="st">"message"</span>, <span class="st">"Operation failed"</span>)
            }

        <span class="kw">return</span> {<span class="st">"success"</span>: <span class="kw">True</span>, <span class="st">"data"</span>: result}

    <span class="kw">except</span> requests.exceptions.<span class="nm">Timeout</span>:
        logger.<span class="fn">error</span>(<span class="st">f"Timeout calling {name}"</span>)
        <span class="kw">return</span> {<span class="st">"success"</span>: <span class="kw">False</span>, <span class="st">"error_code"</span>: <span class="st">"timeout"</span>,
                <span class="st">"message"</span>: <span class="st">"Request timed out. The operation may or may not have executed."</span>}

    <span class="kw">except</span> requests.exceptions.<span class="nm">ConnectionError</span>:
        logger.<span class="fn">error</span>(<span class="st">f"Connection error calling {name}"</span>)
        <span class="kw">return</span> {<span class="st">"success"</span>: <span class="kw">False</span>, <span class="st">"error_code"</span>: <span class="st">"connection_error"</span>,
                <span class="st">"message"</span>: <span class="st">"Could not reach Purple Flea API."</span>}

    <span class="kw">except</span> <span class="nm">Exception</span> <span class="kw">as</span> e:
        logger.<span class="fn">exception</span>(<span class="st">f"Unexpected error calling {name}: {e}"</span>)
        <span class="kw">return</span> {<span class="st">"success"</span>: <span class="kw">False</span>, <span class="st">"error_code"</span>: <span class="st">"internal"</span>,
                <span class="st">"message"</span>: <span class="st">"An unexpected error occurred."</span>}

<span class="cm"># The model receives structured errors and can explain them to the user</span>
<span class="cm"># e.g.: "I tried to open the position but got: insufficient_margin"</span></code></pre>
      </div>

      <div class="callout-warn">
        <p><strong>Idempotency warning:</strong> If a network timeout occurs after sending a trading request, the position may have been opened even though you received no confirmation. Always check open positions before retrying. Use Purple Flea's <code>GET /v1/trading/positions</code> endpoint to verify state before re-sending.</p>
      </div>

      <ul class="feature-list">
        <li>Return structured error objects to the model — it will explain errors to the user in plain language</li>
        <li>Log every tool call with its arguments, result, and latency for audit trails</li>
        <li>Handle timeouts conservatively: assume the operation may have executed</li>
        <li>Set a per-tool request timeout (recommended: 10s for trading, 30s for cross-chain swaps)</li>
        <li>Implement a maximum retry count to prevent runaway agents from hammering the API</li>
      </ul>
    </section>

  </div>
</main>

<footer>
  <div class="footer-inner">
    <div class="footer-brand">
      <span class="diamond">&#9830;</span>
      Purple Flea
    </div>
    <ul class="footer-links">
      <li><a href="https://purpleflea.com/docs">Docs</a></li>
      <li><a href="https://purpleflea.com/for-agents">For Agents</a></li>
      <li><a href="https://purpleflea.com/stats">Stats</a></li>
      <li><a href="https://purpleflea.com/llms.txt">llms.txt</a></li>
      <li><a href="https://github.com/purpleflea">GitHub</a></li>
    </ul>
    <p class="footer-copy">&copy; 2025 Purple Flea. Built for AI agents and the humans who run them.</p>
  </div>
</footer>

<script>
  function copyCode(btn) {
    const pre = btn.closest('.code-block').querySelector('pre');
    const text = pre.innerText;
    navigator.clipboard.writeText(text).then(() => {
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(() => {
        btn.textContent = 'Copy';
        btn.classList.remove('copied');
      }, 2000);
    });
  }
</script>
</body>
</html>
