<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LLM Function Calling for Crypto — Purple Flea API</title>
  <meta name="description" content="The technical bridge between GPT-4 / Claude and Purple Flea APIs. Ready-to-paste tool schemas, full working examples, agent loop patterns, and error handling for crypto operations." />
  <link rel="canonical" href="https://purpleflea.com/llm-function-calling-crypto" />

  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://purpleflea.com/llm-function-calling-crypto" />
  <meta property="og:title" content="LLM Function Calling for Crypto — Purple Flea API" />
  <meta property="og:description" content="The technical bridge between GPT-4 / Claude and Purple Flea APIs. Ready-to-paste tool schemas, full working examples, and agent loop patterns." />
  <meta property="og:image" content="https://purpleflea.com/og-image.png" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="LLM Function Calling for Crypto — Purple Flea API" />
  <meta name="twitter:description" content="The technical bridge between GPT-4 / Claude and Purple Flea APIs. Ready-to-paste tool schemas, full working examples, and agent loop patterns." />
  <meta name="twitter:image" content="https://purpleflea.com/og-image.png" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --purple: #A855F7;
      --purple-dim: #7C3AED;
      --bg: #09090B;
      --text: #FAFAFA;
      --text-secondary: #A1A1AA;
      --text-muted: #71717A;
      --border: rgba(255,255,255,0.06);
      --bg-card: rgba(255,255,255,0.03);
      --radius: 16px;
      --radius-sm: 10px;
      --green: #22C55E;
      --mono: 'JetBrains Mono', monospace;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      font-size: 16px;
    }

    a { color: var(--purple); text-decoration: none; }
    a:hover { color: var(--text); }

    /* NAV */
    nav {
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: rgba(9,9,11,0.92);
      backdrop-filter: blur(12px);
      z-index: 100;
    }

    .nav-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 17px;
      color: var(--text);
      text-decoration: none;
    }

    .nav-logo .diamond { color: var(--purple); font-size: 20px; line-height: 1; }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 28px;
      list-style: none;
    }

    .nav-links a {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      transition: color 0.15s;
    }

    .nav-links a:hover { color: var(--text); }

    /* LAYOUT */
    .container {
      max-width: 860px;
      margin: 0 auto;
      padding: 0 24px;
    }

    /* HERO */
    .hero {
      padding: 88px 24px 68px;
      text-align: center;
      max-width: 860px;
      margin: 0 auto;
    }

    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(168,85,247,0.1);
      border: 1px solid rgba(168,85,247,0.25);
      border-radius: 9999px;
      padding: 4px 14px;
      font-size: 12px;
      font-weight: 600;
      color: var(--purple);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin-bottom: 24px;
    }

    .hero h1 {
      font-size: clamp(2rem, 5vw, 3.1rem);
      font-weight: 700;
      line-height: 1.18;
      letter-spacing: -0.02em;
      margin-bottom: 20px;
    }

    .hero h1 span { color: var(--purple); }

    .hero p {
      font-size: 18px;
      color: var(--text-secondary);
      max-width: 640px;
      margin: 0 auto 36px;
      line-height: 1.75;
    }

    .hero-cta {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--purple);
      color: #fff;
      font-weight: 600;
      font-size: 15px;
      padding: 12px 26px;
      border-radius: 8px;
      transition: background 0.15s;
      text-decoration: none;
    }

    .hero-cta:hover { background: var(--purple-dim); color: #fff; }

    /* SECTIONS */
    .section {
      padding: 60px 0;
      border-top: 1px solid var(--border);
    }

    .section-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--purple);
      margin-bottom: 12px;
    }

    h2 {
      font-size: clamp(1.4rem, 3vw, 1.9rem);
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 16px;
      line-height: 1.25;
    }

    h3 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 10px;
      margin-top: 36px;
      color: var(--text);
    }

    p {
      color: var(--text-secondary);
      margin-bottom: 16px;
      line-height: 1.75;
    }

    /* CODE BLOCKS */
    .code-block {
      position: relative;
      margin: 24px 0;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      overflow: hidden;
    }

    .code-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
    }

    .code-lang {
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .copy-btn {
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 3px 10px;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      letter-spacing: 0.04em;
    }

    .copy-btn:hover { color: var(--purple); border-color: var(--purple); }
    .copy-btn.copied { color: var(--green); border-color: var(--green); }

    pre {
      padding: 20px;
      overflow-x: auto;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.75;
      color: #e2e8f0;
    }

    code { font-family: var(--mono); font-size: 13px; }

    p code, li code {
      background: rgba(168,85,247,0.12);
      border: 1px solid rgba(168,85,247,0.2);
      border-radius: 4px;
      padding: 1px 6px;
      color: var(--purple);
    }

    /* CARDS */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 20px;
    }

    .card-icon { font-size: 22px; margin-bottom: 10px; }

    .card h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text);
    }

    .card p {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 0;
      line-height: 1.6;
    }

    /* API TABLE */
    .api-table {
      width: 100%;
      border-collapse: collapse;
      margin: 24px 0;
      font-size: 13px;
      font-family: var(--mono);
    }

    .api-table th {
      text-align: left;
      padding: 10px 14px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-weight: 600;
    }

    .api-table td {
      padding: 10px 14px;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      vertical-align: top;
    }

    .api-table td:first-child { color: var(--purple); }

    /* FEATURE LIST */
    .feature-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 20px 0;
    }

    .feature-list li {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      color: var(--text-secondary);
      font-size: 15px;
    }

    .feature-list li::before {
      content: '';
      width: 18px;
      height: 18px;
      min-width: 18px;
      border-radius: 50%;
      background: rgba(34,197,94,0.15);
      border: 1px solid rgba(34,197,94,0.3);
      margin-top: 2px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' fill='none'%3E%3Cpath d='M2.5 6l2.5 2.5 4.5-5' stroke='%2322C55E' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: center;
    }

    /* CALLOUT */
    .callout {
      background: rgba(168,85,247,0.06);
      border: 1px solid rgba(168,85,247,0.2);
      border-radius: var(--radius-sm);
      padding: 20px 24px;
      margin: 24px 0;
    }

    .callout p { margin-bottom: 0; color: var(--text-secondary); }
    .callout strong { color: var(--purple); }

    .callout-warn {
      background: rgba(234,179,8,0.06);
      border: 1px solid rgba(234,179,8,0.2);
    }

    .callout-warn strong { color: #EAB308; }

    /* CTA SECTION */
    .cta-section {
      background: rgba(168,85,247,0.05);
      border: 1px solid rgba(168,85,247,0.15);
      border-radius: var(--radius);
      padding: 48px 40px;
      text-align: center;
      margin: 60px 0;
    }

    .cta-section h2 { margin-bottom: 14px; }
    .cta-section p { max-width: 520px; margin: 0 auto 28px; }

    .cta-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--purple);
      color: #fff;
      font-weight: 600;
      font-size: 15px;
      padding: 12px 28px;
      border-radius: 8px;
      transition: background 0.15s;
      text-decoration: none;
      margin: 0 8px 8px;
    }

    .cta-btn:hover { background: var(--purple-dim); color: #fff; }

    .cta-btn-outline {
      background: transparent;
      border: 1px solid rgba(168,85,247,0.4);
      color: var(--purple);
    }

    .cta-btn-outline:hover { background: rgba(168,85,247,0.1); color: var(--purple); border-color: var(--purple); }

    /* FOOTER */
    footer {
      border-top: 1px solid var(--border);
      padding: 40px 24px;
      margin-top: 20px;
    }

    .footer-inner {
      max-width: 860px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .footer-brand {
      display: flex;
      align-items: center;
      gap: 7px;
      font-weight: 700;
      font-size: 15px;
      color: var(--text);
    }

    .footer-brand .diamond { color: var(--purple); }

    .footer-links {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      list-style: none;
    }

    .footer-links a {
      font-size: 13px;
      color: var(--text-muted);
      transition: color 0.15s;
    }

    .footer-links a:hover { color: var(--text); }

    .footer-copy {
      font-size: 12px;
      color: var(--text-muted);
      width: 100%;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      text-align: center;
    }

    /* SYNTAX COLORS */
    .kw  { color: #c792ea; }
    .st  { color: #c3e88d; }
    .cm  { color: #546e7a; font-style: italic; }
    .nm  { color: #82aaff; }
    .op  { color: #89ddff; }
    .nu  { color: #f78c6c; }
    .fn  { color: #82aaff; }
    .at  { color: #ffcb6b; }
    .ky2 { color: #89ddff; }

    @media (max-width: 640px) {
      .nav-links { display: none; }
      .footer-inner { flex-direction: column; align-items: flex-start; }
      .cta-section { padding: 36px 24px; }
    }
  </style>
</head>
<body>

<nav>
  <a href="https://purpleflea.com" class="nav-logo">
    <span class="diamond">&#9830;</span>
    Purple Flea
  </a>
  <ul class="nav-links">
    <li><a href="https://purpleflea.com">Home</a></li>
    <li><a href="https://purpleflea.com/docs">Docs</a></li>
    <li><a href="https://purpleflea.com/for-agents">For Agents</a></li>
    <li><a href="https://purpleflea.com/stats">Stats</a></li>
    <li><a href="https://github.com/purpleflea">GitHub</a></li>
  </ul>
</nav>

<main>
  <section class="hero">
    <div class="hero-badge">Function Calling Guide</div>
    <h1>LLM Function Calling<br>for <span>Crypto Operations</span></h1>
    <p>The technical bridge between GPT-4 / Claude and Purple Flea APIs. Ready-to-paste tool schemas, full working examples, agent loop patterns, and production error handling.</p>
    <a href="https://purpleflea.com/docs" class="hero-cta">Get API access &rarr;</a>
  </section>

  <div class="container">

    <!-- WHAT IS FUNCTION CALLING -->
    <section class="section">
      <div class="section-label">Concepts</div>
      <h2>What is LLM function calling?</h2>
      <p>Modern large language models — GPT-4o, Claude 3.5, Gemini 1.5, and others — can do more than generate prose. When given a set of function schemas, a model can decide to call a function, construct typed JSON arguments, and return a structured call instead of free text. Your application then executes the call and feeds the result back into the conversation.</p>
      <p>This is different from asking a model to "write code". The model emits a machine-readable call like <code>{"name": "wallet_get_balance", "arguments": {"chain": "ethereum"}}</code>. Your handler executes the real API request, the model never touches secrets or private keys, and every action is logged with exact arguments.</p>

      <div class="card-grid">
        <div class="card">
          <div class="card-icon">&#9650;</div>
          <h4>Deterministic outputs</h4>
          <p>Schema-enforced JSON args — no hallucinated payloads or malformed parameters.</p>
        </div>
        <div class="card">
          <div class="card-icon">&#9679;</div>
          <h4>Fully auditable</h4>
          <p>Every call is a discrete logged event: function name, arguments, timestamp.</p>
        </div>
        <div class="card">
          <div class="card-icon">&#9632;</div>
          <h4>Model-agnostic</h4>
          <p>Same Purple Flea API, different schema wrappers for OpenAI, Anthropic, Gemini.</p>
        </div>
        <div class="card">
          <div class="card-icon">&#9830;</div>
          <h4>Secrets never exposed</h4>
          <p>LLM emits intent; your code executes. API keys never appear in model context.</p>
        </div>
      </div>
    </section>

    <!-- HOW IT WORKS — OPENAI -->
    <section class="section">
      <div class="section-label">OpenAI</div>
      <h2>OpenAI function calling mechanics</h2>
      <p>Define tools as a JSON Schema array and pass it to <code>chat.completions.create()</code>. When the model decides to call a tool it returns a message with <code>finish_reason: "tool_calls"</code> and a <code>tool_calls</code> list. You execute each call, append a <code>tool</code> role message with the result, and send the conversation back to get the final reply.</p>

      <div class="callout">
        <p><strong>Key difference from Anthropic:</strong> OpenAI wraps each tool definition in <code>{"type": "function", "function": {...}}</code>. Parameters live under <code>"parameters"</code> with the full JSON Schema object. The response uses <code>message.tool_calls[].function.arguments</code> (a JSON string that must be parsed).</p>
      </div>
    </section>

    <!-- ANTHROPIC TOOL USE -->
    <section class="section">
      <div class="section-label">Anthropic</div>
      <h2>Anthropic tool use mechanics</h2>
      <p>Claude models use a slightly different format. Tool definitions go directly in the <code>tools</code> array without an outer <code>type: "function"</code> wrapper. The parameter schema lives under <code>"input_schema"</code> instead of <code>"parameters"</code>. When Claude calls a tool, the response contains a content block of type <code>"tool_use"</code> with an <code>id</code>, <code>name</code>, and <code>input</code> object (already parsed — no JSON.parse needed).</p>

      <div class="callout">
        <p><strong>Key difference from OpenAI:</strong> <code>input_schema</code> instead of <code>parameters</code>. No outer <code>type: "function"</code> wrapper. Tool results go back as <code>role: "user"</code> content blocks of type <code>"tool_result"</code> referencing the <code>tool_use_id</code>.</p>
      </div>
    </section>

    <!-- TOOL DEFINITIONS -->
    <section class="section">
      <div class="section-label">Tool Schemas</div>
      <h2>Complete Purple Flea tool definitions</h2>
      <p>Six functions covering all four Purple Flea products: Casino (<a href="https://casino.purpleflea.com">casino.purpleflea.com</a>), Trading (<a href="https://trading.purpleflea.com">trading.purpleflea.com</a>), Wallet (<a href="https://wallet.purpleflea.com">wallet.purpleflea.com</a>), and Domains (<a href="https://domains.purpleflea.com">domains.purpleflea.com</a>). The schemas below are in OpenAI format. See the Anthropic example for the equivalent <code>input_schema</code> syntax.</p>

      <table class="api-table">
        <thead>
          <tr>
            <th>Function</th>
            <th>Product</th>
            <th>Required params</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>casino_place_bet</td><td>Casino</td><td>game, amount, side</td></tr>
          <tr><td>trading_open_position</td><td>Trading</td><td>coin, side, size_usd, leverage</td></tr>
          <tr><td>wallet_get_balance</td><td>Wallet</td><td>chain</td></tr>
          <tr><td>wallet_swap</td><td>Wallet</td><td>from_chain, to_chain, from_token, to_token, amount</td></tr>
          <tr><td>domains_search</td><td>Domains</td><td>query</td></tr>
          <tr><td>domains_register</td><td>Domains</td><td>domain</td></tr>
        </tbody>
      </table>

      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">Python — all 6 tools, OpenAI format</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code>PURPLE_FLEA_TOOLS <span class="op">=</span> [

    <span class="cm"># ── Casino ──────────────────────────────────────────────────────────────</span>
    {
        <span class="st">"type"</span>: <span class="st">"function"</span>,
        <span class="st">"function"</span>: {
            <span class="st">"name"</span>: <span class="st">"casino_place_bet"</span>,
            <span class="st">"description"</span>: (
                <span class="st">"Place a provably-fair bet on Purple Flea Casino. "</span>
                <span class="st">"Supported games: coin_flip, dice, crash."</span>
            ),
            <span class="st">"parameters"</span>: {
                <span class="st">"type"</span>: <span class="st">"object"</span>,
                <span class="st">"properties"</span>: {
                    <span class="st">"game"</span>: {
                        <span class="st">"type"</span>: <span class="st">"string"</span>,
                        <span class="st">"enum"</span>: [<span class="st">"coin_flip"</span>, <span class="st">"dice"</span>, <span class="st">"crash"</span>],
                        <span class="st">"description"</span>: <span class="st">"Which casino game to play."</span>
                    },
                    <span class="st">"amount"</span>: {
                        <span class="st">"type"</span>: <span class="st">"number"</span>,
                        <span class="st">"description"</span>: <span class="st">"Bet amount in USD (min 0.01, max 10000)."</span>
                    },
                    <span class="st">"side"</span>: {
                        <span class="st">"type"</span>: <span class="st">"string"</span>,
                        <span class="st">"description"</span>: (
                            <span class="st">"For coin_flip: 'heads' or 'tails'. "</span>
                            <span class="st">"For dice: 'high' (4-6) or 'low' (1-3). "</span>
                            <span class="st">"For crash: target multiplier as string, e.g. '2.5'."</span>
                        )
                    }
                },
                <span class="st">"required"</span>: [<span class="st">"game"</span>, <span class="st">"amount"</span>, <span class="st">"side"</span>]
            }
        }
    },

    <span class="cm"># ── Trading ─────────────────────────────────────────────────────────────</span>
    {
        <span class="st">"type"</span>: <span class="st">"function"</span>,
        <span class="st">"function"</span>: {
            <span class="st">"name"</span>: <span class="st">"trading_open_position"</span>,
            <span class="st">"description"</span>: (
                <span class="st">"Open a perpetual futures position on 275+ markets via "</span>
                <span class="st">"Purple Flea Trading (powered by Hyperliquid)."</span>
            ),
            <span class="st">"parameters"</span>: {
                <span class="st">"type"</span>: <span class="st">"object"</span>,
                <span class="st">"properties"</span>: {
                    <span class="st">"coin"</span>: {
                        <span class="st">"type"</span>: <span class="st">"string"</span>,
                        <span class="st">"description"</span>: <span class="st">"Coin ticker e.g. BTC, ETH, SOL, TSLA."</span>
                    },
                    <span class="st">"side"</span>: {
                        <span class="st">"type"</span>: <span class="st">"string"</span>,
                        <span class="st">"enum"</span>: [<span class="st">"long"</span>, <span class="st">"short"</span>],
                        <span class="st">"description"</span>: <span class="st">"Direction of the position."</span>
                    },
                    <span class="st">"size_usd"</span>: {
                        <span class="st">"type"</span>: <span class="st">"number"</span>,
                        <span class="st">"description"</span>: <span class="st">"Notional position size in USD."</span>
                    },
                    <span class="st">"leverage"</span>: {
                        <span class="st">"type"</span>: <span class="st">"integer"</span>,
                        <span class="st">"minimum"</span>: <span class="nu">1</span>,
                        <span class="st">"maximum"</span>: <span class="nu">50</span>,
                        <span class="st">"description"</span>: <span class="st">"Leverage multiplier (default 1 = no leverage)."</span>
                    }
                },
                <span class="st">"required"</span>: [<span class="st">"coin"</span>, <span class="st">"side"</span>, <span class="st">"size_usd"</span>, <span class="st">"leverage"</span>]
            }
        }
    },

    <span class="cm"># ── Wallet — balance ────────────────────────────────────────────────────</span>
    {
        <span class="st">"type"</span>: <span class="st">"function"</span>,
        <span class="st">"function"</span>: {
            <span class="st">"name"</span>: <span class="st">"wallet_get_balance"</span>,
            <span class="st">"description"</span>: <span class="st">"Fetch the agent's wallet balance on a given chain."</span>,
            <span class="st">"parameters"</span>: {
                <span class="st">"type"</span>: <span class="st">"object"</span>,
                <span class="st">"properties"</span>: {
                    <span class="st">"chain"</span>: {
                        <span class="st">"type"</span>: <span class="st">"string"</span>,
                        <span class="st">"enum"</span>: [
                            <span class="st">"ethereum"</span>, <span class="st">"base"</span>, <span class="st">"polygon"</span>,
                            <span class="st">"arbitrum"</span>, <span class="st">"solana"</span>, <span class="st">"tron"</span>, <span class="st">"bnb"</span>
                        ],
                        <span class="st">"description"</span>: <span class="st">"Blockchain to query."</span>
                    }
                },
                <span class="st">"required"</span>: [<span class="st">"chain"</span>]
            }
        }
    },

    <span class="cm"># ── Wallet — swap ───────────────────────────────────────────────────────</span>
    {
        <span class="st">"type"</span>: <span class="st">"function"</span>,
        <span class="st">"function"</span>: {
            <span class="st">"name"</span>: <span class="st">"wallet_swap"</span>,
            <span class="st">"description"</span>: (
                <span class="st">"Execute a best-rate cross-chain token swap via "</span>
                <span class="st">"Purple Flea Wallet (Wagyu aggregator)."</span>
            ),
            <span class="st">"parameters"</span>: {
                <span class="st">"type"</span>: <span class="st">"object"</span>,
                <span class="st">"properties"</span>: {
                    <span class="st">"from_chain"</span>: {
                        <span class="st">"type"</span>: <span class="st">"string"</span>,
                        <span class="st">"enum"</span>: [<span class="st">"ethereum"</span>, <span class="st">"base"</span>, <span class="st">"polygon"</span>, <span class="st">"arbitrum"</span>, <span class="st">"solana"</span>, <span class="st">"tron"</span>, <span class="st">"bnb"</span>]
                    },
                    <span class="st">"to_chain"</span>: {
                        <span class="st">"type"</span>: <span class="st">"string"</span>,
                        <span class="st">"enum"</span>: [<span class="st">"ethereum"</span>, <span class="st">"base"</span>, <span class="st">"polygon"</span>, <span class="st">"arbitrum"</span>, <span class="st">"solana"</span>, <span class="st">"tron"</span>, <span class="st">"bnb"</span>]
                    },
                    <span class="st">"from_token"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>, <span class="st">"description"</span>: <span class="st">"Token symbol e.g. ETH, USDC, SOL."</span>},
                    <span class="st">"to_token"</span>:   {<span class="st">"type"</span>: <span class="st">"string"</span>, <span class="st">"description"</span>: <span class="st">"Token symbol to receive."</span>},
                    <span class="st">"amount"</span>:     {<span class="st">"type"</span>: <span class="st">"string"</span>, <span class="st">"description"</span>: <span class="st">"Amount as decimal string e.g. '0.5'."</span>}
                },
                <span class="st">"required"</span>: [<span class="st">"from_chain"</span>, <span class="st">"to_chain"</span>, <span class="st">"from_token"</span>, <span class="st">"to_token"</span>, <span class="st">"amount"</span>]
            }
        }
    },

    <span class="cm"># ── Domains — search ────────────────────────────────────────────────────</span>
    {
        <span class="st">"type"</span>: <span class="st">"function"</span>,
        <span class="st">"function"</span>: {
            <span class="st">"name"</span>: <span class="st">"domains_search"</span>,
            <span class="st">"description"</span>: <span class="st">"Search for available crypto/web3 domains on Purple Flea Domains."</span>,
            <span class="st">"parameters"</span>: {
                <span class="st">"type"</span>: <span class="st">"object"</span>,
                <span class="st">"properties"</span>: {
                    <span class="st">"query"</span>: {
                        <span class="st">"type"</span>: <span class="st">"string"</span>,
                        <span class="st">"description"</span>: <span class="st">"Domain name or keyword to search for."</span>
                    }
                },
                <span class="st">"required"</span>: [<span class="st">"query"</span>]
            }
        }
    },

    <span class="cm"># ── Domains — register ──────────────────────────────────────────────────</span>
    {
        <span class="st">"type"</span>: <span class="st">"function"</span>,
        <span class="st">"function"</span>: {
            <span class="st">"name"</span>: <span class="st">"domains_register"</span>,
            <span class="st">"description"</span>: <span class="st">"Register a domain via Purple Flea Domains. Call domains_search first."</span>,
            <span class="st">"parameters"</span>: {
                <span class="st">"type"</span>: <span class="st">"object"</span>,
                <span class="st">"properties"</span>: {
                    <span class="st">"domain"</span>: {
                        <span class="st">"type"</span>: <span class="st">"string"</span>,
                        <span class="st">"description"</span>: <span class="st">"Full domain name to register e.g. 'myagent.crypto'."</span>
                    }
                },
                <span class="st">"required"</span>: [<span class="st">"domain"</span>]
            }
        }
    },

]</code></pre>
      </div>
    </section>

    <!-- OPENAI FULL EXAMPLE -->
    <section class="section">
      <div class="section-label">Working Example</div>
      <h2>Full example: OpenAI function calling with Purple Flea</h2>
      <p>This is a self-contained Python script. It defines all six tools, sends a user message, dispatches any tool calls against the Purple Flea API, and feeds results back to get a final answer from the model.</p>

      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">Python — OpenAI full example (70 lines)</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="kw">import</span> json, os, requests
<span class="kw">from</span> openai <span class="kw">import</span> OpenAI

client    <span class="op">=</span> <span class="fn">OpenAI</span>()
PF_KEY    <span class="op">=</span> os.environ[<span class="st">"PURPLEFLEA_API_KEY"</span>]
PF_BASE   <span class="op">=</span> <span class="st">"https://api.purpleflea.com/v1"</span>
PF_WALLET <span class="op">=</span> <span class="st">"https://wallet.purpleflea.com/v1"</span>
PF_DOM    <span class="op">=</span> <span class="st">"https://domains.purpleflea.com/v1"</span>

<span class="cm"># Paste the PURPLE_FLEA_TOOLS list from the section above here.</span>
<span class="cm"># (Abbreviated for readability.)</span>
tools <span class="op">=</span> PURPLE_FLEA_TOOLS

<span class="kw">def</span> <span class="fn">pf</span>(method, url, **kwargs):
    <span class="st">"""Thin wrapper: attach auth header, raise on HTTP error."""</span>
    headers <span class="op">=</span> {<span class="st">"Authorization"</span>: <span class="st">f"Bearer {PF_KEY}"</span>, <span class="op">**</span>kwargs.pop(<span class="st">"headers"</span>, {})}
    r <span class="op">=</span> <span class="fn">getattr</span>(requests, method)(url, headers<span class="op">=</span>headers, timeout<span class="op">=</span><span class="nu">15</span>, <span class="op">**</span>kwargs)
    r.<span class="fn">raise_for_status</span>()
    <span class="kw">return</span> r.<span class="fn">json</span>()

<span class="kw">def</span> <span class="fn">dispatch</span>(name: str, args: dict) <span class="op">-&gt;</span> dict:
    <span class="st">"""Execute a Purple Flea function call and return its result."""</span>
    <span class="kw">if</span> name <span class="op">==</span> <span class="st">"casino_place_bet"</span>:
        <span class="kw">return</span> <span class="fn">pf</span>(<span class="st">"post"</span>, <span class="st">f"{PF_BASE}/casino/bet"</span>, json<span class="op">=</span>args)

    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"trading_open_position"</span>:
        <span class="kw">return</span> <span class="fn">pf</span>(<span class="st">"post"</span>, <span class="st">f"{PF_BASE}/trading/positions"</span>, json<span class="op">=</span>args)

    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"wallet_get_balance"</span>:
        chain <span class="op">=</span> args[<span class="st">"chain"</span>]
        <span class="kw">return</span> <span class="fn">pf</span>(<span class="st">"get"</span>, <span class="st">f"{PF_WALLET}/wallet/balance/{chain}"</span>)

    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"wallet_swap"</span>:
        <span class="kw">return</span> <span class="fn">pf</span>(<span class="st">"post"</span>, <span class="st">f"{PF_WALLET}/wallet/swap"</span>, json<span class="op">=</span>args)

    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"domains_search"</span>:
        <span class="kw">return</span> <span class="fn">pf</span>(<span class="st">"get"</span>, <span class="st">f"{PF_DOM}/domains/search"</span>, params<span class="op">=</span>args)

    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"domains_register"</span>:
        <span class="kw">return</span> <span class="fn">pf</span>(<span class="st">"post"</span>, <span class="st">f"{PF_DOM}/domains/register"</span>, json<span class="op">=</span>args)

    <span class="kw">else</span>:
        <span class="kw">raise</span> <span class="fn">ValueError</span>(<span class="st">f"Unknown tool: {name}"</span>)

<span class="kw">def</span> <span class="fn">chat</span>(user_message: str) <span class="op">-&gt;</span> str:
    messages <span class="op">=</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: user_message}]

    <span class="kw">while</span> <span class="kw">True</span>:
        resp <span class="op">=</span> client.chat.completions.<span class="fn">create</span>(
            model<span class="op">=</span><span class="st">"gpt-4o"</span>,
            tools<span class="op">=</span>tools,
            messages<span class="op">=</span>messages,
        )
        msg <span class="op">=</span> resp.choices[<span class="nu">0</span>].message

        <span class="kw">if</span> resp.choices[<span class="nu">0</span>].finish_reason <span class="op">!=</span> <span class="st">"tool_calls"</span>:
            <span class="kw">return</span> msg.content  <span class="cm"># done — return final text reply</span>

        messages.<span class="fn">append</span>(msg)  <span class="cm"># append assistant message with tool_calls</span>

        <span class="kw">for</span> tc <span class="kw">in</span> msg.tool_calls:
            name   <span class="op">=</span> tc.<span class="fn">function</span>.name
            args   <span class="op">=</span> json.<span class="fn">loads</span>(tc.<span class="fn">function</span>.arguments)
            result <span class="op">=</span> <span class="fn">dispatch</span>(name, args)
            messages.<span class="fn">append</span>({
                <span class="st">"role"</span>:         <span class="st">"tool"</span>,
                <span class="st">"tool_call_id"</span>: tc.<span class="fn">id</span>,
                <span class="st">"content"</span>:      json.<span class="fn">dumps</span>(result),
            })
        <span class="cm"># loop back — model will read tool results and continue</span>

<span class="kw">if</span> __name__ <span class="op">==</span> <span class="st">"__main__"</span>:
    reply <span class="op">=</span> <span class="fn">chat</span>(<span class="st">"Check my ETH balance, then flip a $10 coin on heads."</span>)
    <span class="fn">print</span>(reply)</code></pre>
      </div>
    </section>

    <!-- ANTHROPIC FULL EXAMPLE -->
    <section class="section">
      <div class="section-label">Working Example</div>
      <h2>Full example: Anthropic tool use with Purple Flea</h2>
      <p>Identical logic to the OpenAI version, but with the Anthropic Python SDK. Note the schema differences: <code>input_schema</code> instead of <code>parameters</code>, no outer <code>type: "function"</code> wrapper, and tool results returned as <code>role: "user"</code> content blocks.</p>

      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">Python — Anthropic full example (55 lines)</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="kw">import</span> json, os, requests
<span class="kw">import</span> anthropic

client  <span class="op">=</span> anthropic.<span class="fn">Anthropic</span>()
PF_KEY  <span class="op">=</span> os.environ[<span class="st">"PURPLEFLEA_API_KEY"</span>]
MODEL   <span class="op">=</span> <span class="st">"claude-opus-4-6"</span>

<span class="cm"># Anthropic format: no outer type wrapper, input_schema instead of parameters</span>
tools <span class="op">=</span> [
    {
        <span class="st">"name"</span>: <span class="st">"casino_place_bet"</span>,
        <span class="st">"description"</span>: <span class="st">"Place a provably-fair bet. Games: coin_flip, dice, crash."</span>,
        <span class="st">"input_schema"</span>: {
            <span class="st">"type"</span>: <span class="st">"object"</span>,
            <span class="st">"properties"</span>: {
                <span class="st">"game"</span>:   {<span class="st">"type"</span>: <span class="st">"string"</span>, <span class="st">"enum"</span>: [<span class="st">"coin_flip"</span>, <span class="st">"dice"</span>, <span class="st">"crash"</span>]},
                <span class="st">"amount"</span>: {<span class="st">"type"</span>: <span class="st">"number"</span>, <span class="st">"description"</span>: <span class="st">"Bet amount in USD."</span>},
                <span class="st">"side"</span>:   {<span class="st">"type"</span>: <span class="st">"string"</span>, <span class="st">"description"</span>: <span class="st">"Game-specific side selection."</span>}
            },
            <span class="st">"required"</span>: [<span class="st">"game"</span>, <span class="st">"amount"</span>, <span class="st">"side"</span>]
        }
    },
    {
        <span class="st">"name"</span>: <span class="st">"trading_open_position"</span>,
        <span class="st">"description"</span>: <span class="st">"Open a perp futures position on 275+ markets."</span>,
        <span class="st">"input_schema"</span>: {
            <span class="st">"type"</span>: <span class="st">"object"</span>,
            <span class="st">"properties"</span>: {
                <span class="st">"coin"</span>:     {<span class="st">"type"</span>: <span class="st">"string"</span>},
                <span class="st">"side"</span>:     {<span class="st">"type"</span>: <span class="st">"string"</span>, <span class="st">"enum"</span>: [<span class="st">"long"</span>, <span class="st">"short"</span>]},
                <span class="st">"size_usd"</span>: {<span class="st">"type"</span>: <span class="st">"number"</span>},
                <span class="st">"leverage"</span>: {<span class="st">"type"</span>: <span class="st">"integer"</span>, <span class="st">"minimum"</span>: <span class="nu">1</span>, <span class="st">"maximum"</span>: <span class="nu">50</span>}
            },
            <span class="st">"required"</span>: [<span class="st">"coin"</span>, <span class="st">"side"</span>, <span class="st">"size_usd"</span>, <span class="st">"leverage"</span>]
        }
    },
    {
        <span class="st">"name"</span>: <span class="st">"wallet_get_balance"</span>,
        <span class="st">"description"</span>: <span class="st">"Get wallet balance on a given chain."</span>,
        <span class="st">"input_schema"</span>: {
            <span class="st">"type"</span>: <span class="st">"object"</span>,
            <span class="st">"properties"</span>: {
                <span class="st">"chain"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>,
                          <span class="st">"enum"</span>: [<span class="st">"ethereum"</span>,<span class="st">"base"</span>,<span class="st">"polygon"</span>,<span class="st">"arbitrum"</span>,<span class="st">"solana"</span>,<span class="st">"tron"</span>,<span class="st">"bnb"</span>]}
            },
            <span class="st">"required"</span>: [<span class="st">"chain"</span>]
        }
    },
    {
        <span class="st">"name"</span>: <span class="st">"wallet_swap"</span>,
        <span class="st">"description"</span>: <span class="st">"Cross-chain token swap via Wagyu aggregator."</span>,
        <span class="st">"input_schema"</span>: {
            <span class="st">"type"</span>: <span class="st">"object"</span>,
            <span class="st">"properties"</span>: {
                <span class="st">"from_chain"</span>:  {<span class="st">"type"</span>: <span class="st">"string"</span>},
                <span class="st">"to_chain"</span>:    {<span class="st">"type"</span>: <span class="st">"string"</span>},
                <span class="st">"from_token"</span>:  {<span class="st">"type"</span>: <span class="st">"string"</span>},
                <span class="st">"to_token"</span>:    {<span class="st">"type"</span>: <span class="st">"string"</span>},
                <span class="st">"amount"</span>:      {<span class="st">"type"</span>: <span class="st">"string"</span>}
            },
            <span class="st">"required"</span>: [<span class="st">"from_chain"</span>, <span class="st">"to_chain"</span>, <span class="st">"from_token"</span>, <span class="st">"to_token"</span>, <span class="st">"amount"</span>]
        }
    },
    {
        <span class="st">"name"</span>: <span class="st">"domains_search"</span>,
        <span class="st">"description"</span>: <span class="st">"Search available crypto domains."</span>,
        <span class="st">"input_schema"</span>: {
            <span class="st">"type"</span>: <span class="st">"object"</span>,
            <span class="st">"properties"</span>: {<span class="st">"query"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>}},
            <span class="st">"required"</span>: [<span class="st">"query"</span>]
        }
    },
    {
        <span class="st">"name"</span>: <span class="st">"domains_register"</span>,
        <span class="st">"description"</span>: <span class="st">"Register a domain. Call domains_search first."</span>,
        <span class="st">"input_schema"</span>: {
            <span class="st">"type"</span>: <span class="st">"object"</span>,
            <span class="st">"properties"</span>: {<span class="st">"domain"</span>: {<span class="st">"type"</span>: <span class="st">"string"</span>}},
            <span class="st">"required"</span>: [<span class="st">"domain"</span>]
        }
    },
]

<span class="kw">def</span> <span class="fn">dispatch</span>(name, args):  <span class="cm"># same logic as OpenAI example above</span>
    base <span class="op">=</span> <span class="st">"https://api.purpleflea.com/v1"</span>
    h <span class="op">=</span> {<span class="st">"Authorization"</span>: <span class="st">f"Bearer {PF_KEY}"</span>}
    <span class="kw">if</span>   name <span class="op">==</span> <span class="st">"casino_place_bet"</span>:       <span class="kw">return</span> requests.<span class="fn">post</span>(<span class="st">f"{base}/casino/bet"</span>, headers<span class="op">=</span>h, json<span class="op">=</span>args, timeout<span class="op">=</span><span class="nu">15</span>).<span class="fn">json</span>()
    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"trading_open_position"</span>:   <span class="kw">return</span> requests.<span class="fn">post</span>(<span class="st">f"{base}/trading/positions"</span>, headers<span class="op">=</span>h, json<span class="op">=</span>args, timeout<span class="op">=</span><span class="nu">15</span>).<span class="fn">json</span>()
    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"wallet_get_balance"</span>:     <span class="kw">return</span> requests.<span class="fn">get</span>(<span class="st">f"https://wallet.purpleflea.com/v1/wallet/balance/{args['chain']}"</span>, headers<span class="op">=</span>h, timeout<span class="op">=</span><span class="nu">15</span>).<span class="fn">json</span>()
    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"wallet_swap"</span>:           <span class="kw">return</span> requests.<span class="fn">post</span>(<span class="st">"https://wallet.purpleflea.com/v1/wallet/swap"</span>, headers<span class="op">=</span>h, json<span class="op">=</span>args, timeout<span class="op">=</span><span class="nu">15</span>).<span class="fn">json</span>()
    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"domains_search"</span>:        <span class="kw">return</span> requests.<span class="fn">get</span>(<span class="st">"https://domains.purpleflea.com/v1/domains/search"</span>, headers<span class="op">=</span>h, params<span class="op">=</span>args, timeout<span class="op">=</span><span class="nu">15</span>).<span class="fn">json</span>()
    <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"domains_register"</span>:      <span class="kw">return</span> requests.<span class="fn">post</span>(<span class="st">"https://domains.purpleflea.com/v1/domains/register"</span>, headers<span class="op">=</span>h, json<span class="op">=</span>args, timeout<span class="op">=</span><span class="nu">15</span>).<span class="fn">json</span>()

<span class="kw">def</span> <span class="fn">chat</span>(user_message: str) <span class="op">-&gt;</span> str:
    messages <span class="op">=</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: user_message}]

    <span class="kw">while</span> <span class="kw">True</span>:
        resp <span class="op">=</span> client.messages.<span class="fn">create</span>(
            model<span class="op">=</span>MODEL, max_tokens<span class="op">=</span><span class="nu">1024</span>, tools<span class="op">=</span>tools, messages<span class="op">=</span>messages
        )

        <span class="kw">if</span> resp.stop_reason <span class="op">!=</span> <span class="st">"tool_use"</span>:
            <span class="cm"># Extract the text block from the response</span>
            <span class="kw">return</span> <span class="fn">next</span>(b.text <span class="kw">for</span> b <span class="kw">in</span> resp.content <span class="kw">if</span> b.type <span class="op">==</span> <span class="st">"text"</span>)

        <span class="cm"># Append the full assistant response (may contain text + tool_use blocks)</span>
        messages.<span class="fn">append</span>({<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: resp.content})

        <span class="cm"># Build tool_result blocks for every tool_use block</span>
        tool_results <span class="op">=</span> []
        <span class="kw">for</span> block <span class="kw">in</span> resp.content:
            <span class="kw">if</span> block.type <span class="op">!=</span> <span class="st">"tool_use"</span>:
                <span class="kw">continue</span>
            result <span class="op">=</span> <span class="fn">dispatch</span>(block.name, block.input)
            tool_results.<span class="fn">append</span>({
                <span class="st">"type"</span>:        <span class="st">"tool_result"</span>,
                <span class="st">"tool_use_id"</span>: block.<span class="fn">id</span>,
                <span class="st">"content"</span>:     json.<span class="fn">dumps</span>(result),
            })

        messages.<span class="fn">append</span>({<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: tool_results})

<span class="kw">if</span> __name__ <span class="op">==</span> <span class="st">"__main__"</span>:
    <span class="fn">print</span>(<span class="fn">chat</span>(<span class="st">"Search for 'defibot.crypto', then register it if available."</span>))</code></pre>
      </div>
    </section>

    <!-- AGENT LOOP PATTERN -->
    <section class="section">
      <div class="section-label">Agent Loop</div>
      <h2>The agent loop pattern</h2>
      <p>A single function call is useful; an agent loop is powerful. The model keeps calling tools until it decides it has enough information to give a final answer, or until you impose a step limit. This enables multi-step plans like "check my balance on all chains, consolidate to base, then open a BTC long".</p>

      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">Python — generic agent loop with step cap</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="kw">import</span> json

MAX_STEPS <span class="op">=</span> <span class="nu">10</span>  <span class="cm"># safety cap — prevent runaway spending</span>

<span class="kw">def</span> <span class="fn">run_agent</span>(system_prompt: str, user_message: str, tools: list) <span class="op">-&gt;</span> str:
    <span class="st">"""
    Generic agent loop.
    - Calls the LLM in a while True loop.
    - Dispatches any tool_calls / tool_use blocks.
    - Returns the final text reply or raises after MAX_STEPS.
    """</span>
    messages <span class="op">=</span> [{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: user_message}]
    steps    <span class="op">=</span> <span class="nu">0</span>

    <span class="kw">while</span> steps <span class="op">&lt;</span> MAX_STEPS:
        steps <span class="op">+=</span> <span class="nu">1</span>

        resp <span class="op">=</span> client.chat.completions.<span class="fn">create</span>(  <span class="cm"># or anthropic client</span>
            model<span class="op">=</span><span class="st">"gpt-4o"</span>,
            tools<span class="op">=</span>tools,
            messages<span class="op">=</span>messages,
        )
        msg    <span class="op">=</span> resp.choices[<span class="nu">0</span>].message
        reason <span class="op">=</span> resp.choices[<span class="nu">0</span>].finish_reason

        <span class="kw">if</span> reason <span class="op">!=</span> <span class="st">"tool_calls"</span>:
            <span class="kw">return</span> msg.content  <span class="cm"># agent is done</span>

        messages.<span class="fn">append</span>(msg)

        <span class="kw">for</span> tc <span class="kw">in</span> msg.tool_calls:
            name   <span class="op">=</span> tc.<span class="fn">function</span>.name
            args   <span class="op">=</span> json.<span class="fn">loads</span>(tc.<span class="fn">function</span>.arguments)
            <span class="fn">print</span>(<span class="st">f"[step {steps}] calling {name}({args})"</span>)
            result <span class="op">=</span> <span class="fn">dispatch</span>(name, args)          <span class="cm"># your dispatcher</span>
            <span class="fn">print</span>(<span class="st">f"[step {steps}] result: {result}"</span>)
            messages.<span class="fn">append</span>({
                <span class="st">"role"</span>:         <span class="st">"tool"</span>,
                <span class="st">"tool_call_id"</span>: tc.<span class="fn">id</span>,
                <span class="st">"content"</span>:      json.<span class="fn">dumps</span>(result),
            })

    <span class="kw">raise</span> <span class="fn">RuntimeError</span>(<span class="st">f"Agent exceeded {MAX_STEPS} steps without completing."</span>)

<span class="cm"># Example: multi-step agent</span>
reply <span class="op">=</span> <span class="fn">run_agent</span>(
    system_prompt<span class="op">=</span><span class="st">"You are a crypto trading agent. Be concise. Always confirm amounts before acting."</span>,
    user_message<span class="op">=</span><span class="st">"Check my ETH and SOL balances, then open a $200 BTC long at 3x leverage."</span>,
    tools<span class="op">=</span>PURPLE_FLEA_TOOLS,
)
<span class="fn">print</span>(reply)</code></pre>
      </div>

      <ul class="feature-list">
        <li>Always impose a <code>MAX_STEPS</code> limit. Without it a buggy prompt can loop and burn funds.</li>
        <li>Log every tool call (name + args) to a persistent store for compliance and debugging.</li>
        <li>Consider a confirmation step for irreversible operations — have the agent state its plan, require human approval, then execute.</li>
        <li>For long-running agents, checkpoint <code>messages</code> to a database so you can resume after a crash.</li>
      </ul>
    </section>

    <!-- ERROR HANDLING -->
    <section class="section">
      <div class="section-label">Error Handling</div>
      <h2>Error handling and retry logic</h2>
      <p>Financial API calls can fail for many reasons: rate limits, network timeouts, insufficient balance, or invalid arguments. The dispatcher is the right place to catch these errors and return structured error objects to the model so it can reason about what went wrong.</p>

      <div class="callout callout-warn">
        <p><strong>Never raise exceptions from your dispatcher in a live agent.</strong> If an exception propagates out of the tool call handler it will crash the loop and you lose the conversation context. Instead, return a structured error dict — the model can read it, inform the user, and decide whether to retry.</p>
      </div>

      <div class="code-block">
        <div class="code-header">
          <span class="code-lang">Python — resilient dispatcher with retries</span>
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        </div>
        <pre><code><span class="kw">import</span> time, requests
<span class="kw">from</span> requests.exceptions <span class="kw">import</span> Timeout, ConnectionError, HTTPError

PF_KEY <span class="op">=</span> os.environ[<span class="st">"PURPLEFLEA_API_KEY"</span>]

<span class="kw">def</span> <span class="fn">pf_request</span>(method: str, url: str, retries: int <span class="op">=</span> <span class="nu">3</span>, **kwargs) <span class="op">-&gt;</span> dict:
    <span class="st">"""
    Resilient HTTP helper.
    - Retries 3 times with exponential backoff on 429 / 5xx / network errors.
    - Returns a structured error dict instead of raising on final failure.
    """</span>
    headers <span class="op">=</span> {<span class="st">"Authorization"</span>: <span class="st">f"Bearer {PF_KEY}"</span>}
    backoff <span class="op">=</span> <span class="nu">1.0</span>

    <span class="kw">for</span> attempt <span class="kw">in</span> <span class="fn">range</span>(retries):
        <span class="kw">try</span>:
            r <span class="op">=</span> <span class="fn">getattr</span>(requests, method)(
                url, headers<span class="op">=</span>headers, timeout<span class="op">=</span><span class="nu">15</span>, <span class="op">**</span>kwargs
            )

            <span class="kw">if</span> r.status_code <span class="op">==</span> <span class="nu">429</span>:
                retry_after <span class="op">=</span> <span class="fn">float</span>(r.headers.<span class="fn">get</span>(<span class="st">"Retry-After"</span>, backoff))
                time.<span class="fn">sleep</span>(retry_after)
                backoff <span class="op">*=</span> <span class="nu">2</span>
                <span class="kw">continue</span>

            <span class="kw">if</span> r.status_code <span class="op">&gt;=</span> <span class="nu">500</span>:
                time.<span class="fn">sleep</span>(backoff)
                backoff <span class="op">*=</span> <span class="nu">2</span>
                <span class="kw">continue</span>

            r.<span class="fn">raise_for_status</span>()
            <span class="kw">return</span> r.<span class="fn">json</span>()

        <span class="kw">except</span> (Timeout, ConnectionError) <span class="kw">as</span> e:
            <span class="kw">if</span> attempt <span class="op">==</span> retries <span class="op">-</span> <span class="nu">1</span>:
                <span class="kw">return</span> {<span class="st">"error"</span>: <span class="st">"network_error"</span>, <span class="st">"message"</span>: <span class="fn">str</span>(e)}
            time.<span class="fn">sleep</span>(backoff); backoff <span class="op">*=</span> <span class="nu">2</span>

        <span class="kw">except</span> HTTPError <span class="kw">as</span> e:
            <span class="cm"># 4xx errors are not retryable (bad args, auth failure, etc.)</span>
            <span class="kw">try</span>:
                body <span class="op">=</span> r.<span class="fn">json</span>()
            <span class="kw">except</span> Exception:
                body <span class="op">=</span> {<span class="st">"raw"</span>: r.text}
            <span class="kw">return</span> {
                <span class="st">"error"</span>:   <span class="st">"api_error"</span>,
                <span class="st">"status"</span>:  r.status_code,
                <span class="st">"message"</span>: body.<span class="fn">get</span>(<span class="st">"message"</span>, <span class="fn">str</span>(e)),
                <span class="st">"details"</span>: body,
            }

    <span class="kw">return</span> {<span class="st">"error"</span>: <span class="st">"max_retries_exceeded"</span>, <span class="st">"message"</span>: <span class="st">f"Failed after {retries} attempts."</span>}


<span class="kw">def</span> <span class="fn">dispatch</span>(name: str, args: dict) <span class="op">-&gt;</span> dict:
    <span class="st">"""Dispatcher with structured error passthrough to the model."""</span>
    <span class="kw">try</span>:
        <span class="kw">if</span> name <span class="op">==</span> <span class="st">"casino_place_bet"</span>:
            <span class="kw">return</span> <span class="fn">pf_request</span>(<span class="st">"post"</span>, <span class="st">"https://api.purpleflea.com/v1/casino/bet"</span>, json<span class="op">=</span>args)
        <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"trading_open_position"</span>:
            <span class="kw">return</span> <span class="fn">pf_request</span>(<span class="st">"post"</span>, <span class="st">"https://api.purpleflea.com/v1/trading/positions"</span>, json<span class="op">=</span>args)
        <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"wallet_get_balance"</span>:
            chain <span class="op">=</span> args[<span class="st">"chain"</span>]
            <span class="kw">return</span> <span class="fn">pf_request</span>(<span class="st">"get"</span>, <span class="st">f"https://wallet.purpleflea.com/v1/wallet/balance/{chain}"</span>)
        <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"wallet_swap"</span>:
            <span class="kw">return</span> <span class="fn">pf_request</span>(<span class="st">"post"</span>, <span class="st">"https://wallet.purpleflea.com/v1/wallet/swap"</span>, json<span class="op">=</span>args)
        <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"domains_search"</span>:
            <span class="kw">return</span> <span class="fn">pf_request</span>(<span class="st">"get"</span>, <span class="st">"https://domains.purpleflea.com/v1/domains/search"</span>, params<span class="op">=</span>args)
        <span class="kw">elif</span> name <span class="op">==</span> <span class="st">"domains_register"</span>:
            <span class="kw">return</span> <span class="fn">pf_request</span>(<span class="st">"post"</span>, <span class="st">"https://domains.purpleflea.com/v1/domains/register"</span>, json<span class="op">=</span>args)
        <span class="kw">else</span>:
            <span class="kw">return</span> {<span class="st">"error"</span>: <span class="st">"unknown_tool"</span>, <span class="st">"message"</span>: <span class="st">f"No handler for tool '{name}'."</span>}
    <span class="kw">except</span> Exception <span class="kw">as</span> e:
        <span class="cm"># Last-resort catch — agent loop must never crash</span>
        <span class="kw">return</span> {<span class="st">"error"</span>: <span class="st">"unexpected_error"</span>, <span class="st">"message"</span>: <span class="fn">repr</span>(e)}</code></pre>
      </div>

      <h3>What the model sees when a call fails</h3>
      <p>When <code>dispatch</code> returns <code>{"error": "api_error", "status": 400, "message": "Insufficient balance"}</code>, the model reads this as a tool result and can respond appropriately — informing the user, suggesting a smaller amount, or checking balance first. This is far more useful than an exception that crashes the loop.</p>

      <ul class="feature-list">
        <li>Retry on 429 (rate limit) and 5xx (server errors) with exponential backoff. Do not retry 4xx.</li>
        <li>Set a hard <code>timeout=15</code> on every request. Financial operations should never hang indefinitely.</li>
        <li>Return structured error dicts — the model can reason about <code>error</code>, <code>status</code>, and <code>message</code> fields.</li>
        <li>Log every call outcome (success and failure) with timestamp, function name, and args for audit purposes.</li>
        <li>For irreversible operations (bets, trades, registrations) consider idempotency keys to avoid duplicate execution on retry.</li>
      </ul>
    </section>

    <!-- CTA -->
    <div class="cta-section">
      <div class="section-label" style="text-align:center; margin-bottom:16px;">Get started</div>
      <h2>Register for Purple Flea APIs</h2>
      <p>Get your API key, browse the full schema reference, and start building LLM agents that operate on real crypto markets in minutes.</p>
      <a href="https://purpleflea.com/docs" class="cta-btn">Read the docs</a>
      <a href="https://purpleflea.com/register" class="cta-btn cta-btn-outline">Create account</a>
    </div>

  </div>
</main>

<footer>
  <div class="footer-inner">
    <div class="footer-brand">
      <span class="diamond">&#9830;</span>
      Purple Flea
    </div>
    <ul class="footer-links">
      <li><a href="https://purpleflea.com/docs">Docs</a></li>
      <li><a href="https://purpleflea.com/for-agents">For Agents</a></li>
      <li><a href="https://purpleflea.com/stats">Stats</a></li>
      <li><a href="https://purpleflea.com/llms.txt">llms.txt</a></li>
      <li><a href="https://github.com/purpleflea">GitHub</a></li>
    </ul>
    <p class="footer-copy">&copy; 2025 Purple Flea. Built for AI agents and the humans who run them.</p>
  </div>
</footer>

<script>
  function copyCode(btn) {
    const pre = btn.closest('.code-block').querySelector('pre');
    navigator.clipboard.writeText(pre.innerText).then(() => {
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
    });
  }
</script>
</body>
</html>
